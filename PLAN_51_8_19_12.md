# Plan: Task 51.8 (click-out), 19.12 (SVG blur), and task table

**No code changes in this step.** This document is the implementation plan. The project must continue to deploy successfully to Railway (static frontend + FastAPI; no new build steps or dependencies).

---

## 1. Scope and constraints

- **51.8** – Measured materials: when editing length from the canvas, any click away (outside the popover) must commit the value and close; currently the user has to click within the element.
- **19.12** – SVG elements become very blurry when their colour is changed until restored to original; fix tinting/rendering so coloured elements stay sharp.
- **Task table** – The uncompleted-tasks table at the top of `TASK_LIST.md` is already correct: Section 51 lists 51.7, 51.8; Section 19 has 19.12. No change needed to the table.

---

## 2. Task 51.8 – Click-out to commit and close badge length popover

### 2.1 Current behaviour (verified in code)

- **Location:** `frontend/app.js`: badge length popover is opened on **double-click** on a measurement badge (canvas `dblclick` → `hitTestBadge` → show `#badgeLengthPopover`, focus `#badgeLengthInput`).
- **Close/commit:** `closeAndSave()` is triggered by:
  - `input` **blur** (via `onBlur`, registered once).
  - **Enter** in `onKeydown`.
  - **Document `mousedown`**: `onDocumentMousedown` checks `popover.contains(ev.target)`; if the target is outside the popover, it calls `closeAndSave()`.
- **Listener:** `document.addEventListener('mousedown', onDocumentMousedown)` is added with `setTimeout(..., 0)` (no capture phase).

### 2.2 Likely cause of “must click within the element”

- Clicks **on the canvas** may not be reaching the document listener in a way that runs before canvas logic, or the event may be consumed before it bubbles to `document`.
- The main canvas uses `canvas.addEventListener('pointerdown', ...)` with `e.preventDefault()` and `canvas.setPointerCapture(e.pointerId)`. It does **not** call `stopPropagation()`, so in principle `mousedown` should bubble. However:
  - Event order and focus behaviour can make “click away” unreliable (e.g. canvas handling the pointer first, or blur not firing as expected when clicking canvas).
- Making “any click away” reliable is best done by handling outside clicks in **capture phase** so the popover logic runs **before** the canvas (or any other element) handles the click.

### 2.3 Intended behaviour (no assumptions)

- **Click away:** Any click whose target is **outside** `#badgeLengthPopover` (including on the canvas, toolbar, or any other area) must:
  1. Commit the current input value to the element’s `measuredLength` (same as current `closeAndSave()`).
  2. Close the popover and exit edit mode (clear `state.badgeLengthEditElementId`, hide popover, remove listeners).
- **Click inside popover:** No change; user can keep editing. `popover.contains(ev.target)` already guards this.
- **Enter / Escape:** Keep current behaviour (Enter commits and closes; Escape discards and closes without committing).

### 2.4 Implementation plan (51.8)

1. **Use capture phase for the outside-click listener**
   - Change from:
     - `document.addEventListener('mousedown', onDocumentMousedown)`
   - To:
     - `document.addEventListener('mousedown', onDocumentMousedown, true)` (capture = true).
   - This ensures the handler runs before the canvas (or any child) handles the click.

2. **Optionally prevent the click from reaching the canvas when we close**
   - When `onDocumentMousedown` runs and calls `closeAndSave()` (click outside popover), call `ev.stopPropagation()` and `ev.preventDefault()` so the same click does not start a canvas action (e.g. selection or drag). This keeps “click away” as “commit and close only”, with no secondary action.
   - **File:** `frontend/app.js`, in the `canvas.addEventListener('dblclick', ...)` callback where `onDocumentMousedown` and the listener are defined.

3. **No HTML or CSS changes** for this task.

4. **Regression checks**
   - Double-click badge → popover opens, input focused.
   - Click **on canvas** (empty area or on another element) → value commits, popover closes.
   - Click **on toolbar / header** → value commits, popover closes.
   - Click **inside popover** (input or label) → popover stays open.
   - Enter commits and closes; Escape closes without committing.
   - No new dependencies; no impact on Railway deploy.

---

## 3. Task 19.12 – SVG colour change blur (tinted elements stay sharp)

### 3.1 Current behaviour (verified in code)

- **Tinting:** `createTintedCanvas(originalImage, color, width, height)` in `frontend/app.js` creates an offscreen canvas of size `width` × `height` (the element’s logical size, e.g. 80×80 or up to 150px). It draws the original image at that size and applies the colour mask. The result is cached on the element as `tintedCanvas` with `tintedCanvasWidth` / `tintedCanvasHeight` matching `el.width` / `el.height`.
- **Drawing:** In `draw()`, the element is drawn with `ctx.drawImage(renderImage, -dw/2, -dh/2, dw, dh)` where `dw = el.width * scale`, `dh = el.height * scale`, and `scale` is the canvas view scale (`state.scale`). So the tinted canvas (e.g. 80×80) is scaled up to `dw`×`dh` (e.g. 160×160 when scale is 2). Scaling a small bitmap up causes blur.
- **SVG assets:** Marley assets are loaded as images from `/assets/marley/*.svg`. When used as `HTMLImageElement`, they are rasterized at their intrinsic size (or the size used in `drawImage`). In `createTintedCanvas` we use `ctx.drawImage(originalImage, 0, 0, width, height)` with `width`/`height` = element logical size (small). So we rasterize the SVG at low resolution into the tinted canvas, then that low-res bitmap is scaled again when drawing to the main canvas → blur. Restoring to “original colour” uses `originalImage` directly, which is drawn at `el.width*scale` × `el.height*scale` from the same small logical size; the perceived improvement when “restored” may be due to no extra tint canvas step or different scaling path.

### 3.2 Root cause (no assumptions)

- Tinted canvas is built at **element logical size** (e.g. 80×80). When the view is zoomed (e.g. scale 2), we draw this 80×80 image into a larger destination (e.g. 160×160), so the browser scales up a low-resolution bitmap → blur.
- SVG sources are especially susceptible because they are rasterized at the size we use in `createTintedCanvas` (small), whereas the untinted `originalImage` might be drawn in a way that appears sharper in some cases; the tint path explicitly uses a small offscreen canvas.

### 3.3 Intended behaviour (no assumptions)

- Changing an SVG (or any) element’s colour must not make it noticeably blurrier than the same element at default colour when viewed at the same zoom. Coloured elements should stay sharp.

### 3.4 Implementation plan (19.12)

1. **Create tinted canvas at higher resolution**
   - In `createTintedCanvas`, create the offscreen canvas at a larger size so we have more source pixels before any scaling on the main canvas. Options:
     - **Option A (recommended):** Use a fixed scale factor (e.g. 2 or 3) so the tinted canvas is `(width * scaleFactor)` × `(height * scaleFactor)`. Then when drawing the element, we still use `ctx.drawImage(renderImage, -dw/2, -dh/2, dw, dh)` with the same `dw`/`dh`; the browser will scale down the higher-res tinted canvas into the same destination, giving a sharper result when the main canvas then scales the scene.
     - **Option B:** Use `window.devicePixelRatio` (or a cap, e.g. `Math.min(devicePixelRatio, 3)`) so high-DPI screens get a sharper tinted bitmap.
   - Implementation detail: `createTintedCanvas` would take or compute a scale factor (e.g. 2), create the canvas at `width*scaleFactor`, `height*scaleFactor`, draw the original image at that size, then return this larger canvas. The rest of the draw path already scales the render image to `dw`×`dh`, so no change needed there—the higher-res tinted canvas will simply provide a sharper source.

2. **Cache key and element cache**
   - The cache key in `getElementRenderImage` is currently `el.color`, `el.width`, `el.height`. If we add a scale factor, the tinted canvas size changes; we can either:
     - Store the scale factor used (e.g. on the element or in a module constant) and include it in the cache key, or
     - Use a constant scale factor (e.g. 2) so the cache key stays the same but the stored `tintedCanvas` has dimensions `el.width*2`, `el.height*2`. Then we must store `tintedCanvasWidth`/`tintedCanvasHeight` as the actual canvas dimensions so we don’t regenerate unnecessarily, and the draw call `drawImage(renderImage, -dw/2, -dh/2, dw, dh)` remains correct (destination size unchanged; source is larger, so scaling is down = sharper).

3. **Where to change**
   - **`createTintedCanvas`:** Add an internal scale factor (e.g. 2). Create canvas with `width * scaleFactor`, `height * scaleFactor`; draw the original image at that size; return the canvas. No change to function signature if we use a constant.
   - **`getElementRenderImage`:** When creating the tinted canvas, pass the same logical `el.width`, `el.height`; `createTintedCanvas` will create a 2× (or 3×) canvas internally. Cache `tintedCanvasWidth`/`tintedCanvasHeight` as the **actual** offscreen canvas dimensions (e.g. `el.width*2`, `el.height*2`) so the cache key for “already built for this color/size” still works. The draw code does not need to change because `drawImage(img, dx, dy, dWidth, dHeight)` scales the image to the destination size regardless of the source bitmap size.
   - **No `imageSmoothingEnabled`** is set today; we could set `ctx.imageSmoothingEnabled = true` and `imageSmoothingQuality = 'high'` when drawing the tinted result on the main canvas if needed, but the main fix is higher-resolution tinted canvas.

4. **Regression and quality checks**
   - SVG (and PNG) elements: change colour → remain sharp at 1× and zoomed in.
   - Restore to default colour → still sharp.
   - No new dependencies; no impact on Railway deploy.

---

## 4. Uncompleted tasks table (TASK_LIST.md)

- **Verification:** The table at the top of `TASK_LIST.md` (lines 16–39) already contains:
  - **Section 51:** 51.7, 51.8 — “Confirm Job popup UI refine; measured materials: any click away should commit length”.
  - **Section 19:** 19.12 — “SVG elements extremely blurry when colour changed until restored to original”.
- **Conclusion:** No update to the task file is required for the table.

---

## 5. Railway and project rules

- **Railway:** All changes are frontend-only (vanilla JS/CSS/HTML). No new env vars, no new backend deps, no change to `Procfile` / `nixpacks.toml` / `railway.json`. Deploy must remain successful.
- **Branching:** Per `.cursor/rules/github-rule.mdc`, use a single feature branch (e.g. `feature/51-8-19-12`), update the “Current Working Branch” block in `TASK_LIST.md` when starting, and merge to `main` when 51.7, 51.8, and 19.12 are done (51.7 is UI refine only; can be same branch or separate).
- **Task list:** When 51.8 and 19.12 are completed, mark them `[x]` in `TASK_LIST.md` (and 51.7 when done). No separate task list elsewhere.

---

## 6. Summary

| Item | Action |
|------|--------|
| **51.8** | Use capture-phase `document.addEventListener('mousedown', ..., true)` for badge popover outside-click; optionally `stopPropagation`/`preventDefault` when closing so the click doesn’t hit the canvas. |
| **19.12** | Create tinted canvas at 2× (or 2–3×) resolution in `createTintedCanvas`; keep cache and draw destination size unchanged so coloured elements stay sharp. |
| **Task table** | No change; already lists 51.7, 51.8 and 19.12. |
| **Railway** | No config or dependency changes; frontend-only. |

This plan is intended to be complete and free of unwarranted assumptions; implementation can follow it step by step.
