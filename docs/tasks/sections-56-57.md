## 56. Strangler Fig: Carve out toolbar.js (ES module)

*Context: Reduce app.js size and isolate mobile diagram toolbar logic by moving it to a dedicated ES module. No build step; Railway deployment unchanged. Desktop and mobile behavior preserved. Plan: docs/plans/2026-02-21-strangler-fig-toolbar-js-carve-out.md.*

- [x] **56.1** **Phase 1 – Create toolbar.js and move code.** Create `frontend/toolbar.js`; move from app.js lines 5678–6089 (constants, diagramToolbarDragCleanup, getDiagramToolbarWrap, applyDiagramToolbarPosition, clampNumber, getDiagramToolbarTopPad, computeMobileToolbarEdgeSnap, applyMobileToolbarEdgeSnap, clampDiagramToolbarToWrap, initDiagramToolbarDrag). Inject getViewportMode via initDiagramToolbarDrag(options); replace all layoutState.viewportMode reads with the getter; pass getter into helpers that need it. Export only initDiagramToolbarDrag. Remove the same block from app.js; add at top of app.js: import { initDiagramToolbarDrag } from './toolbar.js'; define initDiagramToolbarDragWithApp that passes getViewportMode; replace all three call sites with initDiagramToolbarDragWithApp().
- [x] **56.2** **Phase 2 – Wire ES module in HTML.** In index.html change script to `<script type="module" src="/app.js"></script>`. Confirm no inline handlers depend on app.js globals (none found); attach to window any app.js symbols if external refs exist.
- [x] **56.3** **Phase 3 – Verify and deploy.** Manual check: desktop and mobile diagram toolbar drag/collapse/snap; run E2E (npm test or ./scripts/run-e2e.sh); confirm Railway deploy succeeds with no new build step.

---

## 57. Mobile canvas fit + pan lock refinement (desktop-safe, Railway-safe)

*Context: Mobile previously used a fixed logical page fit path in `draw()` and allowed viewport pan at fit level. This section refines mobile so Fit is viewport-based with a 20px inset and panning is only needed when zoomed in. Desktop behavior and Railway deployment must remain unchanged.*

- [x] **57.1** **Mobile fit math: replace fixed-page mapping with viewport fit.** Implemented in `frontend/app.js` `draw()`: mobile fit now derives `baseScale` directly from viewport dimensions (`w`, `h`) with shared fit math and no fixed-page constants; desktop transform behavior unchanged.
- [x] **57.2** **20px inset at Fit on mobile.** Implemented: fit-level scale/offset uses strict 20px padding target (`Vw - 40`, `Vh - 40`) against the active content bbox, centered by base offsets. Follow-up fix (Feb 21, 2026): use logical canvas dimensions (`canvasWidth/Height ÷ devicePixelRatio`) in `draw()` fit math so high-DPR mobile devices no longer mis-scale/misalign the initial fit.
- [x] **57.3** **Pan gating: mobile pan only when zoomed in (+ fit-level resistance feedback).** Implemented: empty-canvas drag pan, wheel pan path, and pinch translation are locked at `viewZoom <= 1` and remain enabled for `viewZoom > 1`, without affecting element manipulation gestures. Added subtle fit-level resistance/bounce feedback so pan attempts at fit are acknowledged.
- [x] **57.4** **Fit-level recenter/reset policy.** Implemented: Fit button, new blueprint upload, and min-zoom clamp transitions reset to centered fit (`viewPanX = 0`, `viewPanY = 0`) and clear transient fit-feedback offsets.
- [x] **57.5** **Automated regression coverage (mobile + desktop guard).** Implemented in `e2e/run.js`: assertions for mobile fit inset (~20px), fit-level pan lock, pan resume after zoom-in, and Fit recenter reset; full E2E suite passes.
- [ ] **57.6** **Manual QA + deployment safety sign-off.** Validate portrait/landscape mobile behavior, 200% zoom accessibility, and toolbar/panel/canvas interactions; run existing tests and confirm no Procfile/Dockerfile/nixpacks/Railway config changes.

---

**MVP status:** All tasks in sections 1–8 are complete. Section 9 items are deferred. Sections 10–12 are complete. Section 13.1–13.3 complete; 13.4–13.5 optional. Section 14 complete. Section 15.1–15.4 and 15.7–15.14 complete; 15.5–15.6 optional. Section 16 complete. Section 17 complete (drill-through with Alt, blueprint lock, lock picture to background). Section 18 complete (18.9–18.11: rotated handle hit test, rotation-aware cursors, rotate handle accessibility). Section 19 complete (blueprint disappearance fix). Section 20 added (anchor-based resize). Section 21 complete (transparency slider via dedicated checkerboard button at blueprint top-left; works when locked; slider blue, number input fixed; E2E tests). Section 22 in progress: 22.1–22.4, 22.5–22.14, 22.16–22.19 complete; 22.15, 22.20–22.24 remaining. Quote modal has Add item to add lines manually. Section 23 complete (CSV product import). Section 25 complete (all Marley diagram SVGs uploaded; downpipe joiner mapping fixed). Section 24 complete (profile filter dropdown implemented). Section 26 added (billing logic: manual guttering distance, dropper 4 screws, saddle/adjustable clip 2 screws). Section 27 complete (Digital Takeoff / Measurement Deck – badges, panel, two-way highlight, quote length→quantity). Section 28 added (Delete element only; badge double-click length entry). Section 29 complete (manual pop-up UI: metres, gutter/downpipe labels, red/green states). Section 30 complete (expand blueprint image types: clipboard paste, HEIC, PDF frontend conversion; BMP/TIFF/AVIF/GIF out of scope). Section 55 complete (55.1–55.10).

*Last updated: Feb 2026. Section 54: 54.46–54.48 complete; 54.49–54.53 + 54.50.1 mobile refinements; 54.56–54.60 always thin edge-only (plan: docs/plans/2026-02-20-mobile-diagram-toolbar-always-thin-edge-only.md); 54.61–54.64 implemented; 54.66 checklist added (`docs/QA-CHECKLIST-2026-02-20-mobile-freeform-interaction-parity.md`); 54.65 pending manual gesture-arbitration QA; 54.75 complete (token consistency + horizontal toolbar scroll, E2E Option B); 54.76 complete (collapsed circle at horizontal orientation); 54.77 complete (horizontal scroll at ≤430px: removed 430px wrap override; toolbar.js skips drag when pointer inside tools-wrap); 54.78 complete (vertical toolbar tighter fit + overflow-y auto in pill, optional drag handle span removed; plan: docs/plans/2026-02-21-mobile-vertical-toolbar-tighter-fit.md); 54.79 complete (mobile: hide drag handle visually, central grip bar, hide Inspector in diagram toolbar; plan: docs/plans/2026-02-21-54-79-mobile-diagram-toolbar-hide-handle-grip-hide-inspector.md); 54.83 complete (mobile ruler-based measurement entry, no auto keyboard on measurable tap, E2E + README updated, icon affordance refined to a clear ruler glyph). Section 57 in progress: 57.1–57.5 complete (viewport-fit 20px inset, fit-level pan lock with subtle resistance feedback, automated regression coverage); 57.6 manual sign-off pending. Section 55 complete. Section 49: jobmaterial POST 400 (49.24). Section 48: Railway deployment. See TROUBLESHOOTING.md for displayed_amount error.*
